import flet
from flet import (
    ElevatedButton,
    FilePicker,
    FilePickerResultEvent,
    Page,
    Row,
    Text,
    icons,
    CircleAvatar,
    colors,
    Image,
    Column,
    Container,
    padding,
    alignment,
    FontWeight,
    Divider,
    FilledButton,
    CircleBorder,
    ButtonStyle,
    MaterialState,
    IconButton,
    AlertDialog,
    TextButton,
    Banner,
    Icon
)

# the var result is setted here cause we still don't have the detector
# just to let u know (
#               if result == "Malware" will assume that every detection ends with a malware detection
#               elif result  == "Genuine" will assume that every detection ends with a genuine detection
#             )
result = "Malware"


def main(page: Page):
    page.scroll = "Auto"
    page.window_width = 800        # window's width is 200 px
    page.window_height = 700       # window's height is 200 px
    page.update()
    color_file_detected = colors.BACKGROUND
    
    dlg = AlertDialog(
        title=Text("You have to select a file :)", font_family="Verdana")
    )
    
    def close_banner(e):
        page.banner.open = False
        page.update()
    
    def show_mlw_banner():
        page.banner = Banner(
            bgcolor=colors.RED,
            leading=Icon(icons.WARNING_AMBER_ROUNDED, color=colors.AMBER, size=40),
            content=Text(
                "Malware Detected!!!"
            ),
            actions=[
                TextButton("Close", on_click=close_banner, style=ButtonStyle(color=flet.colors.BLACK),),
            ],
        )
        page.banner.open = True
        page.update()
        
    def show_safe_banner():
        page.banner = Banner(
            bgcolor=colors.GREEN,
            leading=Icon(icons.SAFETY_CHECK, color=colors.GREEN_800, size=40),
            content=Text(
                "The file is safe"
            ),
            actions=[
                TextButton("Close", on_click=close_banner, style=ButtonStyle(color=flet.colors.BLACK),),
            ],
        )    
        page.banner.open = True
        page.update()

    def open_dlg():
        page.dialog = dlg
        dlg.open = True
        page.update()
        
    # Pick files dialog
    def pick_files_result(e: FilePickerResultEvent):
        selected_files.value = (
            e.files[0].path if e.files else "Empty"
        )
        selected_files.update()

    pick_files_dialog = FilePicker(on_result=pick_files_result)
    selected_files = Text(value="Empty")

    def toggle_icon_button(e):
        if selected_files.value == "Empty":
            open_dlg()
            return
        try:
            close_banner({})
        except: pass
        e.control.selected = not e.control.selected
        e.control.update()
        if e.control.selected:
            # TO CHANGE: as soon as we have the function to compute the classification
            # execute classification
            # get result
            if result == "Malware":
                show_mlw_banner()
            else:
                show_safe_banner()
            e.control.selected = False
            e.control.update()
            return
        else:
            # stop classification
            return
            
    # hide all dialogs in overlay
    page.overlay.extend([pick_files_dialog])

    page.add(
        
        Container(
            # alignment for aligning content in center
            alignment=alignment.center,
            # child control
            content=Column(
                alignment="center",
                horizontal_alignment="center",
                controls=[
                    Image(
                        src=f"https://www.architettura.uniroma1.it/sites/sf01/files/Angioletto_Logo_Bianco.png",
                        width=100,
                        height=100,
                        fit=flet.ImageFit.CONTAIN,
                    ),
                    Text(
                        "Malware Analyzer",
                        size=30,
                        color=colors.WHITE,
                        weight=FontWeight.W_100,
                    ),
                    Divider(
                        height=10,
                        thickness=3,
                    ),
                    Column(
                        height=330,
                        controls=[
                        Container(
                            bgcolor=color_file_detected,
                            height=300,
                            content=IconButton(
                                icon=icons.NOT_STARTED_ROUNDED,
                                icon_color="blue_50",
                                icon_size=150,
                                selected_icon=icons.PAUSE_CIRCLE_FILLED_ROUNDED,
                                selected=False,
                                on_click=toggle_icon_button,
                                style=ButtonStyle(color={"selected": colors.RED, "": colors.GREEN}),
                            ),
                            padding=50
                        )
                        ]
                    ),
                    Container(
                        alignment=alignment.center,
                        content=
                            Column(
                                alignment="center",
                                horizontal_alignment="center",
                                controls=[
                                    ElevatedButton(
                                        "Pick file",
                                        icon=icons.UPLOAD_FILE,
                                        on_click=lambda _: pick_files_dialog.pick_files(
                                            allow_multiple=True
                                        ),
                                    ),
                                    selected_files,
                                ]
                            )
                    )
                ]
            )
        )
    )


flet.app(target=main)


